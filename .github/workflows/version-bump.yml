name: Version Bump

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      bump_type:
        description: "Version bump type"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write

jobs:
  bump:
    name: Bump Version
    runs-on: ubuntu-latest
    # Skip bot commits (e.g. dependabot) unless manually triggered
    if: >-
      github.event_name == 'workflow_dispatch' ||
      !startsWith(github.event.head_commit.author.name, 'dependabot')
    outputs:
      version: ${{ steps.next.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Determine bump type
        id: bump
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "type=${{ inputs.bump_type }}" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Find the merged PR for this push
          COMMIT_SHA="${{ github.sha }}"
          LABELS=$(gh api "repos/${{ github.repository }}/commits/${COMMIT_SHA}/pulls" \
            --jq '.[0].labels[].name' 2>/dev/null || echo "")

          if echo "$LABELS" | grep -qx "major"; then
            echo "type=major" >> $GITHUB_OUTPUT
          elif echo "$LABELS" | grep -qx "minor"; then
            echo "type=minor" >> $GITHUB_OUTPUT
          else
            echo "type=patch" >> $GITHUB_OUTPUT
          fi

      - name: Get current version
        id: current
        run: |
          # Only consider semver tags (v*.*.*), skip non-version tags like gh-attach-assets
          CURRENT_TAG=$(git tag -l 'v[0-9]*.[0-9]*.[0-9]*' --sort=-v:refname | head -1)
          CURRENT_TAG="${CURRENT_TAG:-v0.0.0}"
          echo "tag=${CURRENT_TAG}" >> $GITHUB_OUTPUT

      - name: Calculate next version
        id: next
        run: |
          CURRENT="${{ steps.current.outputs.tag }}"
          CURRENT="${CURRENT#v}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
          case "${{ steps.bump.outputs.type }}" in
            major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
            minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
            patch) PATCH=$((PATCH + 1)) ;;
          esac
          echo "version=v${MAJOR}.${MINOR}.${PATCH}" >> $GITHUB_OUTPUT

      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ steps.next.outputs.version }}" -m "Release ${{ steps.next.outputs.version }}"
          git push origin "${{ steps.next.outputs.version }}"

  release:
    name: Create Release
    needs: bump
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.bump.outputs.version }}
          fetch-depth: 0

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.bump.outputs.version }}
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-homebrew:
    name: Update Homebrew Formula
    needs: [bump, release]
    runs-on: ubuntu-latest
    steps:
      - name: Get release info
        id: release
        run: |
          VERSION="${{ needs.bump.outputs.version }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Download tarball and calculate SHA256
          URL="https://github.com/${{ github.repository }}/archive/refs/tags/${VERSION}.tar.gz"
          SHA256=$(curl -sL "$URL" | sha256sum | cut -d' ' -f1)
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: Checkout homebrew-tap
        uses: actions/checkout@v6
        with:
          repository: atani/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}

      - name: Update formula
        run: |
          VERSION="${{ steps.release.outputs.version }}"
          SHA256="${{ steps.release.outputs.sha256 }}"
          URL="${{ steps.release.outputs.url }}"

          # Update formula file
          sed -i "s|url \".*\"|url \"$URL\"|" Formula/gh-attach.rb
          sed -i "s|sha256 \".*\"|sha256 \"$SHA256\"|" Formula/gh-attach.rb

      - name: Commit and push
        run: |
          VERSION="${{ steps.release.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/gh-attach.rb
          git diff --staged --quiet && echo "No changes" && exit 0
          git commit -m "gh-attach ${VERSION}"
          git push
